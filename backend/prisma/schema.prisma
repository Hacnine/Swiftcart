// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// ============= USER MANAGEMENT =============

enum UserRole {
  BUYER
  SELLER
  ADMIN
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  BANNED
}

model User {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  email         String        @unique
  password      String
  firstName     String
  lastName      String
  phone         String?
  avatar        String?
  role          UserRole      @default(BUYER)
  status        UserStatus    @default(ACTIVE)
  isEmailVerified Boolean    @default(false)
  emailVerificationToken String?
  resetPasswordToken String?
  resetPasswordExpire DateTime?
  
  // Buyer specific
  addresses     Address[]
  orders        Order[]       @relation("BuyerOrders")
  reviews       Review[]
  wishlist      WishlistItem[]
  cartItems     CartItem[]
  
  // Seller specific
  vendor        Vendor?
  
  // Communication
  sentMessages      Message[]     @relation("MessageSender")
  receivedMessages  Message[]     @relation("MessageReceiver")
  conversations     Conversation[] @relation("ConversationParticipants")
  
  // Notifications
  notifications Notification[]
  
  // Tracking
  lastLogin     DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("users")
}

model Address {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  firstName     String
  lastName      String
  company       String?
  addressLine1  String
  addressLine2  String?
  city          String
  state         String
  zipCode       String
  country       String
  phone         String
  isDefault     Boolean  @default(false)
  
  orders        Order[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("addresses")
}

// ============= VENDOR/SELLER MANAGEMENT =============

enum VendorStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
}

enum VendorType {
  MANUFACTURER
  DISTRIBUTOR
  WHOLESALER
  TRADING_COMPANY
}

model Vendor {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  userId            String        @unique @db.ObjectId
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  storeName         String        @unique
  storeSlug         String        @unique
  storeLogo         String?
  storeBanner       String?
  storeDescription  String?
  
  vendorType        VendorType
  status            VendorStatus  @default(PENDING)
  
  // Business Information
  businessName      String
  businessLicense   String?
  taxId             String?
  
  // Contact
  businessEmail     String
  businessPhone     String
  businessAddress   String
  country           String
  
  // Financial
  bankAccountName   String?
  bankAccountNumber String?
  bankName          String?
  bankSwiftCode     String?
  
  // Stats
  totalSales        Float         @default(0)
  totalOrders       Int           @default(0)
  averageRating     Float         @default(0)
  totalReviews      Int           @default(0)
  
  // Products and Orders
  products          Product[]
  orders            Order[]       @relation("VendorOrders")
  
  // Store Settings
  minimumOrder      Float         @default(0)
  processingTime    Int           @default(3) // in days
  acceptsReturns    Boolean       @default(true)
  returnPeriod      Int           @default(30) // in days
  
  // Verification
  isVerified        Boolean       @default(false)
  verifiedAt        DateTime?
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  
  @@map("vendors")
}

// ============= PRODUCT MANAGEMENT =============

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  OUT_OF_STOCK
}

model Category {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  name          String        @unique
  slug          String        @unique
  description   String?
  image         String?
  icon          String?
  
  parentId      String?       @db.ObjectId
  parent        Category?     @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children      Category[]    @relation("CategoryHierarchy")
  
  products      Product[]
  
  order         Int           @default(0)
  isActive      Boolean       @default(true)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("categories")
}

model Brand {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  name          String    @unique
  slug          String    @unique
  logo          String?
  description   String?
  website       String?
  
  products      Product[]
  
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("brands")
}

model Product {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  
  // Basic Info
  title             String
  slug              String          @unique
  description       String
  shortDescription  String?
  
  // Vendor
  vendorId          String          @db.ObjectId
  vendor            Vendor          @relation(fields: [vendorId], references: [id], onDelete: Cascade)
  
  // Categorization
  categoryId        String          @db.ObjectId
  category          Category        @relation(fields: [categoryId], references: [id])
  
  brandId           String?         @db.ObjectId
  brand             Brand?          @relation(fields: [brandId], references: [id])
  
  // Media
  images            String[]
  videos            String[]
  thumbnail         String?
  
  // Pricing (Wholesale)
  basePrice         Float
  priceRanges       PriceRange[]    // Bulk pricing tiers
  
  // Inventory
  sku               String          @unique
  stock             Int             @default(0)
  minimumOrderQty   Int             @default(1)
  maximumOrderQty   Int?
  
  // Variants
  hasVariants       Boolean         @default(false)
  variants          ProductVariant[]
  
  // Specifications
  specifications    Specification[]
  
  // Shipping
  weight            Float?
  length            Float?
  width             Float?
  height            Float?
  shippingClass     String?
  
  // Status
  status            ProductStatus   @default(DRAFT)
  
  // SEO
  metaTitle         String?
  metaDescription   String?
  metaKeywords      String[]
  
  // Stats
  viewCount         Int             @default(0)
  soldCount         Int             @default(0)
  averageRating     Float           @default(0)
  totalReviews      Int             @default(0)
  
  // Relations
  reviews           Review[]
  wishlistItems     WishlistItem[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  
  // Features
  isFeatured        Boolean         @default(false)
  isNewArrival      Boolean         @default(false)
  isBestSeller      Boolean         @default(false)
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("products")
}

type PriceRange {
  minQuantity       Int
  maxQuantity       Int?
  price             Float
  discountPercent   Float?
}

type Specification {
  name              String
  value             String
}

model ProductVariant {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  productId     String   @db.ObjectId
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  name          String   // e.g., "Color: Red, Size: Large"
  sku           String   @unique
  
  attributes    VariantAttribute[]
  
  price         Float
  stock         Int      @default(0)
  image         String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("product_variants")
}

type VariantAttribute {
  name          String   // e.g., "Color"
  value         String   // e.g., "Red"
}

// ============= CART & WISHLIST =============

model CartItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId     String   @db.ObjectId
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  variantId     String?
  quantity      Int      @default(1)
  price         Float
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("cart_items")
}

model WishlistItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  productId     String   @db.ObjectId
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  
  @@unique([userId, productId])
  @@map("wishlist_items")
}

// ============= ORDER MANAGEMENT =============

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
  DISPUTED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentMethod {
  CREDIT_CARD
  DEBIT_CARD
  PAYPAL
  STRIPE
  BANK_TRANSFER
  COD
}

model Order {
  id                String          @id @default(auto()) @map("_id") @db.ObjectId
  orderNumber       String          @unique
  
  // Buyer
  buyerId           String          @db.ObjectId
  buyer             User            @relation("BuyerOrders", fields: [buyerId], references: [id])
  
  // Vendor
  vendorId          String          @db.ObjectId
  vendor            Vendor          @relation("VendorOrders", fields: [vendorId], references: [id])
  
  // Order Items
  items             OrderItem[]
  
  // Pricing
  subtotal          Float
  shippingCost      Float
  taxAmount         Float
  discountAmount    Float           @default(0)
  totalAmount       Float
  
  // Status
  status            OrderStatus     @default(PENDING)
  paymentStatus     PaymentStatus   @default(PENDING)
  paymentMethod     PaymentMethod
  
  // Shipping Address
  shippingAddressId String          @db.ObjectId
  shippingAddress   Address         @relation(fields: [shippingAddressId], references: [id])
  
  // Tracking
  trackingNumber    String?
  shippingCarrier   String?
  estimatedDelivery DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?
  
  // Payment
  paymentId         String?
  paymentIntentId   String?
  paidAt            DateTime?
  
  // Notes
  buyerNote         String?
  vendorNote        String?
  adminNote         String?
  
  // Cancellation/Refund
  cancelledAt       DateTime?
  cancellationReason String?
  refundedAt        DateTime?
  refundAmount      Float?
  
  // Relations
  reviews           Review[]
  disputes          Dispute[]
  
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  
  @@map("orders")
}

model OrderItem {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  orderId       String   @db.ObjectId
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  productId     String   @db.ObjectId
  product       Product  @relation(fields: [productId], references: [id])
  
  productTitle  String
  productImage  String?
  sku           String
  
  variantId     String?
  variantName   String?
  
  quantity      Int
  unitPrice     Float
  totalPrice    Float
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("order_items")
}

// ============= REVIEWS & RATINGS =============

model Review {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  
  productId     String   @db.ObjectId
  product       Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  userId        String   @db.ObjectId
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  orderId       String   @db.ObjectId
  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  rating        Int      // 1-5
  title         String?
  comment       String
  images        String[]
  
  // Vendor Response
  vendorReply   String?
  vendorRepliedAt DateTime?
  
  // Helpful votes
  helpfulCount  Int      @default(0)
  
  isVerifiedPurchase Boolean @default(true)
  isApproved    Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([userId, productId, orderId])
  @@map("reviews")
}

// ============= MESSAGING SYSTEM =============

model Conversation {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  
  participantIds String[] @db.ObjectId
  participants  User[]    @relation("ConversationParticipants", fields: [participantIds], references: [id])
  
  subject       String?
  productId     String?   @db.ObjectId
  orderId       String?   @db.ObjectId
  
  messages      Message[]
  
  isArchived    Boolean   @default(false)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@map("conversations")
}

model Message {
  id                String        @id @default(auto()) @map("_id") @db.ObjectId
  conversationId    String        @db.ObjectId
  conversation      Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  senderId          String        @db.ObjectId
  sender            User          @relation("MessageSender", fields: [senderId], references: [id])
  
  receiverId        String        @db.ObjectId
  receiver          User          @relation("MessageReceiver", fields: [receiverId], references: [id])
  
  content           String
  attachments       String[]
  
  isRead            Boolean       @default(false)
  readAt            DateTime?
  
  createdAt         DateTime      @default(now())
  
  @@map("messages")
}

// ============= DISPUTES =============

enum DisputeStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum DisputeReason {
  PRODUCT_NOT_RECEIVED
  PRODUCT_DAMAGED
  WRONG_ITEM
  QUALITY_ISSUE
  OTHER
}

model Dispute {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  
  orderId       String        @db.ObjectId
  order         Order         @relation(fields: [orderId], references: [id])
  
  reason        DisputeReason
  description   String
  evidence      String[]      // Images, documents
  
  status        DisputeStatus @default(OPEN)
  
  adminNotes    String?
  resolution    String?
  resolvedAt    DateTime?
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("disputes")
}

// ============= NOTIFICATIONS =============

enum NotificationType {
  ORDER_PLACED
  ORDER_CONFIRMED
  ORDER_SHIPPED
  ORDER_DELIVERED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  REVIEW_RECEIVED
  MESSAGE_RECEIVED
  VENDOR_APPROVED
  VENDOR_REJECTED
  PRODUCT_LOW_STOCK
  DISPUTE_OPENED
  SYSTEM_ANNOUNCEMENT
}

model Notification {
  id            String            @id @default(auto()) @map("_id") @db.ObjectId
  userId        String            @db.ObjectId
  user          User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type          NotificationType
  title         String
  message       String
  link          String?
  
  isRead        Boolean           @default(false)
  readAt        DateTime?
  
  createdAt     DateTime          @default(now())
  
  @@map("notifications")
}

// ============= COUPONS & PROMOTIONS =============

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

model Coupon {
  id            String        @id @default(auto()) @map("_id") @db.ObjectId
  code          String        @unique
  description   String?
  
  discountType  DiscountType
  discountValue Float
  
  minPurchase   Float?
  maxDiscount   Float?
  
  usageLimit    Int?
  usedCount     Int           @default(0)
  
  validFrom     DateTime
  validUntil    DateTime
  
  isActive      Boolean       @default(true)
  
  // Restrictions
  vendorIds     String[]      @db.ObjectId
  categoryIds   String[]      @db.ObjectId
  productIds    String[]      @db.ObjectId
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  
  @@map("coupons")
}

// ============= ANALYTICS & REPORTS =============

model AnalyticsEvent {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  
  eventType     String   // page_view, product_view, add_to_cart, purchase, etc.
  userId        String?  @db.ObjectId
  sessionId     String?
  
  data          Json     // Flexible data storage
  
  ipAddress     String?
  userAgent     String?
  referrer      String?
  
  createdAt     DateTime @default(now())
  
  @@map("analytics_events")
}

// ============= SETTINGS =============

model SystemSetting {
  id            String   @id @default(auto()) @map("_id") @db.ObjectId
  key           String   @unique
  value         Json
  description   String?
  
  updatedAt     DateTime @updatedAt
  
  @@map("system_settings")
}
